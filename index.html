<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eè³‡æ ¼ å…¨ãƒãƒ¼ãƒ‰å±•é–‹ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box
    }

    body {
      font-family: 'Segoe UI', 'Hiragino Sans', 'Meiryo', sans-serif;
      background: #0f1729;
      overflow: hidden;
      user-select: none;
      -webkit-user-select: none;
      touch-action: none;
      -webkit-touch-callout: none
    }

    svg {
      display: block;
      touch-action: none
    }

    .node-group {
      cursor: pointer
    }

    .node-group:hover .node-bg {
      filter: brightness(1.25)
    }

    .link {
      fill: none;
      stroke-linecap: round
    }

    .legend {
      position: fixed;
      bottom: 14px;
      left: 14px;
      background: rgba(15, 23, 41, 0.88);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 10px;
      padding: 12px 16px;
      color: #cbd5e1;
      font-size: 11px;
      z-index: 50
    }

    .legend-title {
      font-weight: 700;
      margin-bottom: 6px;
      color: #f1f5f9;
      font-size: 12px
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 7px;
      margin-bottom: 3px
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0
    }

    .controls {
      position: fixed;
      top: 14px;
      right: 14px;
      display: flex;
      gap: 7px;
      z-index: 50
    }

    .controls button {
      background: rgba(15, 23, 41, 0.85);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #e2e8f0;
      border-radius: 8px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: background 0.2s;
      white-space: nowrap
    }

    .controls button:hover {
      background: rgba(30, 46, 82, 0.9)
    }

    .title-bar {
      position: fixed;
      top: 8px;
      left: 8px;
      color: #f1f5f9;
      z-index: 50;
      max-width: 55%
    }

    .title-bar h1 {
      font-size: 16px;
      font-weight: 700
    }

    .title-bar p {
      font-size: 10.5px;
      color: #94a3b8;
      margin-top: 2px
    }

    @media(max-width:600px) {
      .title-bar h1 {
        font-size: 12px
      }

      .title-bar p {
        font-size: 9px
      }

      .controls {
        top: 8px !important;
        right: 8px !important;
        gap: 4px !important;
        flex-wrap: wrap;
        max-width: 45%
      }

      .controls button {
        padding: 3px 7px !important;
        font-size: 10px !important
      }

      .legend {
        bottom: 8px !important;
        left: 8px !important;
        padding: 8px 10px !important;
        font-size: 9px !important;
        max-width: 45%
      }

      .legend-title {
        font-size: 10px !important
      }

      .search-box {
        top: auto !important;
        bottom: 8px !important;
        right: 8px !important
      }

      .search-box input {
        width: 140px !important;
        font-size: 11px !important
      }

      #detail-panel {
        padding: 18px 20px !important;
        max-height: 85vh !important
      }

      #detail-panel .dp-title {
        font-size: 17px !important
      }

      #detail-panel .dp-body {
        font-size: 12.5px !important
      }
    }

    .search-box {
      position: fixed;
      top: 50px;
      right: 14px;
      z-index: 50;
      display: flex;
      gap: 6px;
      align-items: center
    }

    .search-box input {
      background: rgba(15, 23, 41, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #e2e8f0;
      border-radius: 8px;
      padding: 5px 10px;
      font-size: 12px;
      width: 200px;
      outline: none
    }

    .search-box input::placeholder {
      color: #64748b
    }

    .search-box input:focus {
      border-color: #3b82f6
    }

    .search-box .count {
      color: #94a3b8;
      font-size: 11px
    }

    #detail-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 200;
      display: none;
      align-items: center;
      justify-content: center
    }

    #detail-overlay.show {
      display: flex
    }

    #detail-panel {
      background: #1e293b;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 24px 28px;
      color: #e2e8f0;
      position: relative;
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1)
    }

    #detail-panel .dp-close {
      position: absolute;
      top: 12px;
      right: 16px;
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 22px;
      cursor: pointer
    }

    #detail-panel .dp-close:hover {
      color: #f1f5f9
    }

    #detail-panel .dp-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      margin-bottom: 10px
    }

    #detail-panel .dp-title {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 6px;
      line-height: 1.3
    }

    #detail-panel .dp-subtitle {
      font-size: 13px;
      color: #94a3b8;
      margin-bottom: 14px;
      line-height: 1.7
    }

    #detail-panel .dp-body {
      font-size: 13.5px;
      line-height: 1.7;
      color: #cbd5e1
    }

    .dp-math {
      display: inline-block;
      font-family: 'Cambria Math', 'STIX Two Math', 'Latin Modern Math', 'Times New Roman', serif;
      font-style: italic;
      color: #93c5fd;
      letter-spacing: 0.5px;
      font-size: 105%
    }

    .dp-math-block {
      display: block;
      text-align: center;
      margin: 8px 0;
      padding: 8px 12px;
      background: rgba(59, 130, 246, 0.08);
      border: 1px solid rgba(59, 130, 246, 0.15);
      border-radius: 8px;
      font-family: 'Cambria Math', 'STIX Two Math', 'Latin Modern Math', 'Times New Roman', serif;
      font-style: italic;
      color: #93c5fd;
      font-size: 110%;
      letter-spacing: 0.5px;
      line-height: 1.6
    }

    .dp-math sub,
    .dp-math-block sub {
      font-size: 75%;
      vertical-align: sub
    }

    .dp-math sup,
    .dp-math-block sup {
      font-size: 75%;
      vertical-align: super
    }

    #detail-panel .dp-section {
      margin-top: 14px;
      padding-top: 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.08)
    }

    #detail-panel .dp-section-title {
      font-size: 11px;
      font-weight: 700;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px
    }

    #detail-panel .dp-keywords {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 5px
    }

    #detail-panel .dp-kw {
      background: rgba(255, 255, 255, 0.07);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      padding: 2px 8px;
      font-size: 11.5px;
      color: #e2e8f0
    }

    #detail-panel .dp-hint {
      margin-top: 16px;
      font-size: 11px;
      color: #64748b;
      text-align: center
    }

    #minimap {
      position: fixed;
      bottom: 14px;
      right: 14px;
      background: rgba(15, 23, 41, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 10px;
      z-index: 50;
      cursor: crosshair
    }

    @media(max-width:600px) {
      #minimap {
        display: none
      }
    }

    .dp-crosslink {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      margin-top: 4px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s
    }

    .dp-crosslink:hover {
      background: rgba(59, 130, 246, 0.15)
    }

    .dp-crosslink-path {
      font-size: 11.5px;
      color: #94a3b8;
      flex: 1
    }

    .dp-crosslink-arrow {
      color: #3b82f6;
      font-size: 14px
    }
  </style>
</head>

<body>
  <div class="title-bar">
    <h1>Eè³‡æ ¼ å…¨ãƒãƒ¼ãƒ‰å±•é–‹ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ— (519ãƒãƒ¼ãƒ‰)</h1>
    <p>ã‚¿ãƒƒãƒ—: å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿ ï½œ é•·æŠ¼ã—: è©³ç´°è¡¨ç¤º ï½œ ãƒ‰ãƒ©ãƒƒã‚°: ç§»å‹• ï½œ ãƒ”ãƒ³ãƒ/ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«: ã‚ºãƒ¼ãƒ </p>
  </div>
  <div class="controls">
    <button id="btn-reset">&#x27F2; ãƒªã‚»ãƒƒãƒˆ</button>
    <button id="btn-expand">&#xFF0B; å…¨å±•é–‹</button>
    <button id="btn-collapse">&#xFF0D; æŠ˜ã‚ŠãŸãŸã¿</button>
    <button id="btn-lv2">Lv2</button>
    <button id="btn-lv3">Lv3</button>
  </div>
  <div class="search-box">
    <input id="search" type="text" placeholder="ç”¨èªã‚’æ¤œç´¢...">
    <span class="count" id="search-count"></span>
  </div>
  <div class="legend">
    <div class="legend-title">åˆ†é‡ã‚«ãƒ©ãƒ¼ (519ãƒãƒ¼ãƒ‰)</div>
    <div class="legend-item">
      <div class="legend-dot" style="background:#f59e0b"></div>å¿œç”¨æ•°å­¦
    </div>
    <div class="legend-item">
      <div class="legend-dot" style="background:#10b981"></div>æ©Ÿæ¢°å­¦ç¿’
    </div>
    <div class="legend-item">
      <div class="legend-dot" style="background:#3b82f6"></div>æ·±å±¤å­¦ç¿’ï¼ˆåŸºç¤ï¼‰
    </div>
    <div class="legend-item">
      <div class="legend-dot" style="background:#8b5cf6"></div>æ·±å±¤å­¦ç¿’ï¼ˆå¿œç”¨ï¼‰
    </div>
    <div class="legend-item">
      <div class="legend-dot" style="background:#ec4899"></div>é–‹ç™ºãƒ»é‹ç”¨ç’°å¢ƒ
    </div>
  </div>
  <canvas id="minimap" width="200" height="140"></canvas>
  <div id="detail-overlay">
    <div id="detail-panel">
      <button class="dp-close" id="dp-close">&times;</button>
      <div class="dp-badge" id="dp-badge"></div>
      <div class="dp-title" id="dp-title"></div>
      <div class="dp-subtitle" id="dp-subtitle"></div>
      <div class="dp-body" id="dp-body"></div>
      <div class="dp-hint">é•·æŠ¼ã—ã§è¡¨ç¤º ï½œ ã‚¯ãƒªãƒƒã‚¯/Escã§é–‰ã˜ã‚‹</div>
    </div>
  </div>
  <svg id="canvas"></svg>
  <script>
    fetch('data.json').then(r => r.json()).then(json => {
      const DATA = json.data;
      const ABBR = json.abbr;

      // ==================== ENGINE ====================
      const W = window.innerWidth, H = window.innerHeight;
      const svg = document.getElementById('canvas');
      svg.setAttribute('width', W); svg.setAttribute('height', H);
      let gRoot, ct = { x: 0, y: 0, k: 1 };
      const LG = [0, 180, 145, 125, 110];
      const LINK_GAP = 18;
      let idC = 0, allNodes = [];
      function initNode(n, d = 0) { n._id = idC++; n._depth = d; n._collapsed = d >= 2; n._hl = false; if (n.children) n.children.forEach(c => initNode(c, d + 1)); }
      initNode(DATA);
      function vis(n) { return (!n._collapsed && n.children) ? n.children : []; }
      function flatAll(n, a = []) { a.push(n); if (n.children) n.children.forEach(c => flatAll(c, a)); return a; }
      allNodes = flatAll(DATA);
      const dupeMap = {}; allNodes.forEach(n => { const nm = n.name.replace(/\n/g, ' '); if (!dupeMap[nm]) dupeMap[nm] = []; dupeMap[nm].push(n); });
      let _oX = 60, _oY = 0;
      function layout(root) {
        function ch(n) { const c = vis(n); if (!c.length) { n._h = 1; return 1; } let s = 0; c.forEach(x => s += ch(x)); s += (c.length - 1) * 0.08; n._h = s; return s; }
        function pos(n, x, y) { const c = vis(n); n._x = x; if (!c.length) { n._y = y + 0.5; return; } let off = y; const childX = x + Math.max(LG[Math.min(n._depth + 1, 4)], nw(n) + LINK_GAP); c.forEach(child => { pos(child, childX, off); off += child._h + 0.08; }); n._y = (c[0]._y + c[c.length - 1]._y) / 2; }
        ch(root); pos(root, 0, 0); const g = 28; (function sc(n) { n._y *= g; vis(n).forEach(sc); })(root);
      }
      function collect(n, a = []) { a.push(n); vis(n).forEach(c => collect(c, a)); return a; }
      function lks(n, a = []) { vis(n).forEach(c => { a.push({ s: n, t: c }); lks(c, a); }); return a; }
      const _mSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg'); _mSvg.setAttribute('style', 'position:absolute;top:-9999px;left:-9999px;width:0;height:0;overflow:hidden'); document.body.appendChild(_mSvg);
      const _mt = document.createElementNS('http://www.w3.org/2000/svg', 'text'); _mSvg.appendChild(_mt);
      const _mwCache = {};
      function measureText(s, fontSize) { const key = s + '|' + fontSize; if (_mwCache[key] !== undefined) return _mwCache[key]; _mt.setAttribute('font-size', fontSize); _mt.setAttribute('font-family', "'Segoe UI','Hiragino Sans','Meiryo',sans-serif"); _mt.textContent = s; const w = _mt.getComputedTextLength(); _mwCache[key] = w; return w; }
      function fs(n) { return n._depth === 0 ? 15 : n._depth === 1 ? 11.5 : 10; }
      function nw(n) { const f = fs(n), pad = n._depth === 0 ? 26 : n._depth === 1 ? 18 : 14, min = n._depth === 0 ? 90 : n._depth === 1 ? 72 : 48; const lines = n.name.split('\n'); const maxW = Math.max(...lines.map(s => measureText(s, f))); return Math.max(min, maxW + pad); }
      function nh(n) { const l = n.name.split('\n').length; return n._depth === 0 ? 16 + l * 20 : n._depth === 1 ? 12 + l * 15 : 10 + l * 13; }
      function dk(hex, a) { if (!hex.startsWith('#')) return hex; let r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16); return `rgb(${Math.max(0, r - a)},${Math.max(0, g - a)},${Math.max(0, b - a)})`; }
      function render() {
        layout(DATA); const nodes = collect(DATA), links = lks(DATA);
        let minY = 1e9, maxY = -1e9; nodes.forEach(n => { minY = Math.min(minY, n._y); maxY = Math.max(maxY, n._y); });
        const oX = 60, oY = H / 2 - (minY + maxY) / 2; _oX = oX; _oY = oY;
        let s = `<g id="gRoot" transform="translate(${ct.x},${ct.y}) scale(${ct.k})">`;
        links.forEach(l => { const sx = l.s._x + oX + nw(l.s), sy = l.s._y + oY, tx = l.t._x + oX, ty = l.t._y + oY, mx = (sx + tx) / 2; s += `<path class="link" d="M${sx},${sy} C${mx},${sy} ${mx},${ty} ${tx},${ty}" stroke="${l.t.color}" stroke-width="${l.t._depth >= 3 ? 0.7 : 1.2}" opacity="${l.t._depth >= 3 ? 0.18 : 0.32}"/>`; });
        nodes.forEach(n => {
          const x = n._x + oX, y = n._y + oY, w = nw(n), h = nh(n), r = n._depth === 0 ? 10 : n._depth === 1 ? 7 : 5, f = fs(n), lines = n.name.split('\n'), hasCh = n.children && n.children.length > 0;
          const hlGlow = n._hl ? ` filter="url(#glow)"` : ''
          s += `<g class="node-group" data-id="${n._id}" transform="translate(${x},${y - h / 2})">`;
          if (n._hl) s += `<rect x="-3" y="-3" width="${w + 6}" height="${h + 6}" rx="${r + 2}" fill="none" stroke="#fbbf24" stroke-width="2.5" opacity="0.9"/>`;
          s += `<rect class="node-bg" x="0" y="0" width="${w}" height="${h}" rx="${r}" fill="${dk(n.color, n._hl ? 80 : 120)}" stroke="${n.color}" stroke-width="${n._depth === 0 ? 2.2 : n._hl ? 1.8 : 1}" opacity="${n._depth === 0 ? 1 : n._depth === 1 ? 0.85 : 0.7}"/>`;
          lines.forEach((ln, i) => { const ty2 = h / 2 + (i - (lines.length - 1) / 2) * (f + 1.5); s += `<text x="${w / 2}" y="${ty2}" text-anchor="middle" dominant-baseline="central" fill="${n._depth === 0 ? '#111' : '#f1f5f9'}" font-size="${f}" font-weight="${n._depth <= 1 ? '700' : '500'}" style="pointer-events:none">${ln}</text>`; });
          if (hasCh) { s += `<text x="${w - 4}" y="7" text-anchor="end" font-size="8" fill="${n.color}" opacity="0.8" style="pointer-events:none">${n._collapsed ? '+' + n.children.length : '\u2212'}</text>`; }
          if (n.desc && n.desc.length > 0) { s += `<title>${esc(n.name.replace(/\n/g, ' '))}${n.desc ? ': ' + esc(n.desc) : ''}</title>`; }
          { const _nm = n.name.replace(/\n/g, ' '); if (dupeMap[_nm] && dupeMap[_nm].length > 1 && n._depth >= 2) { s += `<text x="4" y="${h - 3}" font-size="7" fill="#60a5fa" opacity="0.85" style="pointer-events:none">ğŸ”—</text>`; } }
          s += `</g>`;
        });
        s += `</g>`; svg.innerHTML = s; gRoot = document.getElementById('gRoot');
        document.querySelectorAll('.node-group').forEach(el => {
          const id = parseInt(el.dataset.id), node = nodes.find(n => n._id === id); if (!node) return;
          let pt = null, dlp = false;
          el.addEventListener('pointerdown', e => { e.stopPropagation(); e.preventDefault(); dlp = false; pt = setTimeout(() => { dlp = true; showDetail(node); }, 420); });
          el.addEventListener('pointerup', e => { e.stopPropagation(); e.preventDefault(); clearTimeout(pt); if (!dlp && node.children && node.children.length > 0) { node._collapsed = !node._collapsed; render(); } });
          el.addEventListener('pointerleave', () => clearTimeout(pt));
          el.addEventListener('pointercancel', () => clearTimeout(pt));
          el.addEventListener('mousedown', e => e.stopPropagation());
          el.addEventListener('touchstart', e => { e.stopPropagation(); }, { passive: true });
          el.addEventListener('contextmenu', e => e.preventDefault());
        });
        renderMinimap();
      }
      function esc(s) { return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
      // Detail panel - activation function graphs
      function makeGraph(name) {
        const W = 280, H = 150, mx = 30, my = 20, gw = W - mx * 2, gh = H - my * 2;
        const fns = {
          'ReLU': { f: x => Math.max(0, x), r: [-3, 3], yr: [-0.5, 3], color: '#3b82f6', formula: 'f(x) = max(0, x)' },
          'Leaky ReLU': { f: x => x >= 0 ? x : 0.1 * x, r: [-3, 3], yr: [-0.5, 3], color: '#60a5fa', formula: 'f(x) = max(Î±x, x), Î±=0.1' },
          'GELU': { f: x => { const c = Math.sqrt(2 / Math.PI); return 0.5 * x * (1 + Math.tanh(c * (x + 0.044715 * x * x * x))); }, r: [-4, 4], yr: [-0.5, 4], color: '#818cf8', formula: 'f(x) = xÂ·Î¦(x)' },
          'Sigmoid function': { f: x => 1 / (1 + Math.exp(-x)), r: [-6, 6], yr: [-0.1, 1.1], color: '#f59e0b', formula: 'Ïƒ(x) = 1/(1+eâ»Ë£)' },
          'tanh': { f: x => Math.tanh(x), r: [-4, 4], yr: [-1.2, 1.2], color: '#10b981', formula: 'f(x) = tanh(x)' },
          'åŒæ›²ç·šæ­£æ¥é–¢æ•°': { f: x => Math.tanh(x), r: [-4, 4], yr: [-1.2, 1.2], color: '#10b981', formula: 'f(x) = tanh(x)' },
          'Softmax': { f: x => 1 / (1 + Math.exp(-x)), r: [-6, 6], yr: [-0.1, 1.1], color: '#ec4899', formula: 'softmax(záµ¢) = eá¶»â±/Î£eá¶»Ê² (2ã‚¯ãƒ©ã‚¹æ™‚=Ïƒ)' },
          'ã‚½ãƒ•ãƒˆãƒãƒƒã‚¯ã‚¹é–¢æ•°': { f: x => 1 / (1 + Math.exp(-x)), r: [-6, 6], yr: [-0.1, 1.1], color: '#ec4899', formula: 'softmax(záµ¢) = eá¶»â±/Î£eá¶»Ê² (2ã‚¯ãƒ©ã‚¹æ™‚=Ïƒ)' },
        };
        const spec = fns[name];
        if (!spec) return null;
        const { f, r, yr, color, formula } = spec;
        const xMin = r[0], xMax = r[1], yMin = yr[0], yMax = yr[1];
        const toX = v => mx + (v - xMin) / (xMax - xMin) * gw;
        const toY = v => my + (yMax - v) / (yMax - yMin) * gh;
        // Build path
        const pts = [];
        const steps = 80;
        for (let i = 0; i <= steps; i++) {
          const x = xMin + (xMax - xMin) * i / steps;
          const y = f(x);
          const cy = Math.max(yMin, Math.min(yMax, y));
          pts.push(`${i === 0 ? 'M' : 'L'}${toX(x).toFixed(1)},${toY(cy).toFixed(1)}`);
        }
        // Grid lines
        let grid = '';
        // x-axis (y=0)
        if (yMin <= 0 && yMax >= 0) {
          grid += `<line x1="${mx}" y1="${toY(0)}" x2="${mx + gw}" y2="${toY(0)}" stroke="#475569" stroke-width="0.8"/>`;
          grid += `<text x="${mx + gw + 4}" y="${toY(0) + 3}" fill="#64748b" font-size="9">0</text>`;
        }
        // y-axis (x=0)
        if (xMin <= 0 && xMax >= 0) {
          grid += `<line x1="${toX(0)}" y1="${my}" x2="${toX(0)}" y2="${my + gh}" stroke="#475569" stroke-width="0.8"/>`;
        }
        // y=1 dashed line for sigmoid/softmax
        if (yMax >= 1 && (name.includes('Sigmoid') || name.includes('Softmax') || name.includes('ã‚½ãƒ•ãƒˆãƒãƒƒã‚¯ã‚¹'))) {
          grid += `<line x1="${mx}" y1="${toY(1)}" x2="${mx + gw}" y2="${toY(1)}" stroke="#475569" stroke-width="0.5" stroke-dasharray="4,3"/>`;
          grid += `<text x="${mx - 14}" y="${toY(1) + 3}" fill="#64748b" font-size="8">1</text>`;
        }
        // y=-1,1 for tanh
        if (name === 'tanh' || name === 'åŒæ›²ç·šæ­£æ¥é–¢æ•°') {
          grid += `<line x1="${mx}" y1="${toY(1)}" x2="${mx + gw}" y2="${toY(1)}" stroke="#475569" stroke-width="0.5" stroke-dasharray="4,3"/>`;
          grid += `<line x1="${mx}" y1="${toY(-1)}" x2="${mx + gw}" y2="${toY(-1)}" stroke="#475569" stroke-width="0.5" stroke-dasharray="4,3"/>`;
          grid += `<text x="${mx - 14}" y="${toY(1) + 3}" fill="#64748b" font-size="8">1</text>`;
          grid += `<text x="${mx - 18}" y="${toY(-1) + 3}" fill="#64748b" font-size="8">-1</text>`;
        }
        return `<div style="margin:12px 0 6px;text-align:center"><svg width="${W}" height="${H + 22}" viewBox="0 0 ${W} ${H + 22}" style="background:rgba(0,0,0,0.25);border-radius:10px;max-width:100%">${grid}<path d="${pts.join('')}" fill="none" stroke="${color}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/><text x="${W / 2}" y="${H + 16}" text-anchor="middle" fill="#94a3b8" font-size="11" font-family="monospace">${formula}</text></svg></div>`;
      }
      // Math formatting for descriptions
      function fmtMath(text) {
        if (!text) return '';
        let s = esc(text);
        // Extract and format standalone formulas (patterns like X=..., f(x)=...)
        // Subscripts: x_1, Î²_t, w_i, h_{t-1}, x_{t-1} etc
        s = s.replace(/([A-Za-zÎ±-Ï‰Î‘-Î©Î¸ÏƒÎ¼Î»ÎµÎ·Î³Î²Î´Ï„Ï€])_\{([^}]+)\}/g, '$1<sub>$2</sub>');
        s = s.replace(/([A-Za-zÎ±-Ï‰Î‘-Î©Î¸ÏƒÎ¼Î»ÎµÎ·Î³Î²Î´Ï„Ï€])_([A-Za-z0-9])/g, '$1<sub>$2</sub>');
        // Superscripts: x^2, x^t, x^T, Î²^t, Î³^t, x^(-z)
        s = s.replace(/([A-Za-z0-9)])?\^(\([^)]+\))/g, '$1<sup>$2</sup>');
        s = s.replace(/([A-Za-z0-9)])?\^([A-Za-z0-9Â²Â³]+)/g, '$1<sup>$2</sup>');
        // Greek letters display (already in unicode, keep as-is)
        // Sigma/Pi/integral symbols - wrap in math span
        s = s.replace(/(Î£|âˆ«|âˆ‡|âˆ‚|âˆš|âˆ|â‰¤|â‰¥|â‰ |â‰ˆ|âˆˆ|âˆ©|âˆª)/g, '<span class="dp-math">$1</span>');
        // Wrap known formula patterns in math block:
        // Detect lines that look like formulas: contain = and math symbols
        // Split by ã€‚and look for formula-heavy segments
        const parts = s.split(/(?<=ã€‚)/);
        let result = '';
        for (const p of parts) {
          const mathChars = (p.match(/[=+\-*/()Î£âˆ«âˆ‡âˆšâˆ‚â‚€-â‚‰â°-â¹<>Î±Î²Î³Î´ÎµÎ¸Î»Î¼ÏƒÏ„Ï€Î·Ï†]/g) || []).length;
          const isFormula = mathChars > 3 && p.length < 80 && /[=]/.test(p) && !/[\u3000-\u9fff]{6,}/.test(p);
          if (isFormula) {
            result += `<span class="dp-math-block">${p.trim()}</span>`;
          } else {
            result += p;
          }
        }
        return result;
      }
      const overlay = document.getElementById('detail-overlay');
      function showDetail(node) {
        const cat = getCat(node);
        document.getElementById('dp-badge').textContent = cat;
        const b = document.getElementById('dp-badge'); b.style.background = node.color; b.style.color = isLight(node.color) ? '#111' : '#fff';
        const nm = node.name.replace(/\n/g, ' ');
        document.getElementById('dp-title').textContent = nm;
        // Show full name for abbreviations
        const fullName = ABBR[nm] || '';
        document.getElementById('dp-subtitle').innerHTML = (fullName ? '<div style="color:#60a5fa;font-size:12px;margin-bottom:6px;font-style:italic">' + esc(fullName) + '</div>' : '') + fmtMath(node.desc) || '';
        let html = '';
        // Activation function graph
        const graph = makeGraph(node.name.replace(/\n/g, ' '));
        if (graph) html += graph;
        // Show parent path
        const path = getPath(DATA, node);
        if (path.length > 1) { html += `<div class="dp-section"><div class="dp-section-title">ä½ç½®</div><p style="font-size:12px;color:#94a3b8">${path.map(p => esc(p.name.replace(/\n/g, ' '))).join(' â†’ ')}</p></div>`; }
        if (node.children && node.children.length) { html += `<div class="dp-section"><div class="dp-section-title">ã‚µãƒ–ãƒˆãƒ”ãƒƒã‚¯ (${node.children.length})</div><div class="dp-keywords">${node.children.map(c => `<span class="dp-kw">${esc(c.name.replace(/\n/g, ' '))}</span>`).join('')}</div></div>`; }
        // Show siblings
        const parent = findParent(DATA, node);
        if (parent && parent.children && parent.children.length > 1) {
          const siblings = parent.children.filter(c => c._id !== node._id);
          html += `<div class="dp-section"><div class="dp-section-title">åŒã‚«ãƒ†ã‚´ãƒªã®ç”¨èª (${siblings.length})</div><div class="dp-keywords">${siblings.map(c => `<span class="dp-kw">${esc(c.name.replace(/\n/g, ' '))}</span>`).join('')}</div></div>`;
        }
        const _nodeName = node.name.replace(/\n/g, ' ');
        const _dupes = dupeMap[_nodeName];
        if (_dupes && _dupes.length > 1) {
          const _others = _dupes.filter(d => d._id !== node._id);
          html += `<div class="dp-section"><div class="dp-section-title">ğŸ”— ä»–åˆ†é‡ã§ã®ç™»å ´ (${_others.length})</div>`;
          _others.forEach((d, i) => { const p = getPath(DATA, d); html += `<div class="dp-crosslink" data-nav-idx="${i}"><span class="dp-crosslink-path">${p.slice(1, -1).map(x => esc(x.name.replace(/\n/g, ' '))).join(' â€º ') || 'ãƒ«ãƒ¼ãƒˆ'}</span><span class="dp-crosslink-arrow">â†’</span></div>`; });
          html += `</div>`;
        }
        document.getElementById('dp-body').innerHTML = html; overlay.classList.add('show');
        if (_dupes && _dupes.length > 1) {
          const _others = _dupes.filter(d => d._id !== node._id);
          document.querySelectorAll('.dp-crosslink').forEach(el => { const idx = parseInt(el.dataset.navIdx); el.addEventListener('click', () => { overlay.classList.remove('show'); navigateTo(_others[idx]); }); });
        }
      }
      function isLight(h) { if (!h.startsWith('#')) return false; return (parseInt(h.slice(1, 3), 16) * 0.299 + parseInt(h.slice(3, 5), 16) * 0.587 + parseInt(h.slice(5, 7), 16) * 0.114) > 150; }
      function getCat(node) { if (node._depth === 0) return 'Eè³‡æ ¼'; let cur = node; while (cur._depth > 1) { const p = findParent(DATA, cur); if (!p) break; cur = p; } return cur.name.replace(/\n/g, ' '); }
      function findParent(root, target) { if (!root.children) return null; for (const c of root.children) { if (c._id === target._id) return root; const x = findParent(c, target); if (x) return x; } return null; }
      function getPath(root, target) { if (root._id === target._id) return [root]; if (!root.children) return []; for (const c of root.children) { const p = getPath(c, target); if (p.length) { return [root, ...p]; } } return []; }
      overlay.addEventListener('click', e => { if (e.target === overlay) overlay.classList.remove('show'); });
      document.getElementById('dp-close').addEventListener('click', () => overlay.classList.remove('show'));
      document.addEventListener('keydown', e => { if (e.key === 'Escape') overlay.classList.remove('show'); });
      function applyView() { if (gRoot) gRoot.setAttribute('transform', `translate(${ct.x},${ct.y}) scale(${ct.k})`); renderMinimap(); }
      function navigateTo(target) { allNodes.forEach(n => n._hl = false); target._hl = true; (function exp(r, t) { if (r._id === t._id) return true; if (!r.children) return false; for (const c of r.children) { if (exp(c, t)) { r._collapsed = false; return true; } } return false; })(DATA, target); render(); ct.k = Math.max(ct.k, 0.8); ct.x = W / 2 - (target._x + _oX + nw(target) / 2) * ct.k; ct.y = H / 2 - (target._y + _oY) * ct.k; applyView(); }
      // Pan & zoom
      let isDrag = false, ds = { x: 0, y: 0 };
      svg.addEventListener('mousedown', e => { isDrag = true; ds = { x: e.clientX - ct.x, y: e.clientY - ct.y }; svg.style.cursor = 'grabbing'; document.body.style.pointerEvents = 'none'; svg.style.pointerEvents = 'auto'; });
      window.addEventListener('mousemove', e => { if (!isDrag) return; ct.x = e.clientX - ds.x; ct.y = e.clientY - ds.y; applyView(); });
      window.addEventListener('mouseup', () => { isDrag = false; svg.style.cursor = 'default'; document.body.style.pointerEvents = ''; });
      svg.addEventListener('wheel', e => { e.preventDefault(); const d = e.deltaY > 0 ? 0.9 : 1.1, nk = Math.max(0.05, Math.min(5, ct.k * d)), mx = e.clientX, my = e.clientY; ct.x = mx - (mx - ct.x) * (nk / ct.k); ct.y = my - (my - ct.y) * (nk / ct.k); ct.k = nk; applyView(); }, { passive: false });
      // Touch support for mobile
      let tch = { active: false, sx: 0, sy: 0, dist: 0, panning: false };
      function tDist(ts) { return Math.hypot(ts[0].clientX - ts[1].clientX, ts[0].clientY - ts[1].clientY); }
      function tMid(ts) { return { x: (ts[0].clientX + ts[1].clientX) / 2, y: (ts[0].clientY + ts[1].clientY) / 2 }; }
      svg.addEventListener('touchstart', e => {
        if (e.target.closest && e.target.closest('.node-group')) return;
        if (e.touches.length === 1) { tch.active = true; tch.panning = true; tch.sx = e.touches[0].clientX - ct.x; tch.sy = e.touches[0].clientY - ct.y; }
        if (e.touches.length === 2) { e.preventDefault(); tch.dist = tDist(e.touches); tch.mid = tMid(e.touches); tch.panning = false; }
      }, { passive: false });
      svg.addEventListener('touchmove', e => {
        e.preventDefault();
        if (e.touches.length === 1 && tch.panning) { ct.x = e.touches[0].clientX - tch.sx; ct.y = e.touches[0].clientY - tch.sy; applyView(); }
        if (e.touches.length === 2 && tch.dist > 0) { const nd = tDist(e.touches), nm = tMid(e.touches), sc = nd / tch.dist, nk = Math.max(0.05, Math.min(5, ct.k * sc)); ct.x = nm.x - (nm.x - ct.x) * (nk / ct.k); ct.y = nm.y - (nm.y - ct.y) * (nk / ct.k); ct.k = nk; tch.dist = nd; tch.mid = nm; applyView(); }
      }, { passive: false });
      svg.addEventListener('touchend', () => { tch.active = false; tch.panning = false; tch.dist = 0; });
      // Controls
      function setDepth(maxD) { (function r(n, d) { n._collapsed = d >= maxD; if (n.children) n.children.forEach(c => r(c, d + 1)); })(DATA, 0); render(); }
      document.getElementById('btn-reset').addEventListener('click', () => { ct = { x: 0, y: 0, k: 1 }; setDepth(2); });
      document.getElementById('btn-expand').addEventListener('click', () => { (function e(n) { n._collapsed = false; if (n.children) n.children.forEach(e); })(DATA); render(); });
      document.getElementById('btn-collapse').addEventListener('click', () => { setDepth(1); });
      document.getElementById('btn-lv2').addEventListener('click', () => { setDepth(2); });
      document.getElementById('btn-lv3').addEventListener('click', () => { setDepth(3); });
      // Search
      const searchInput = document.getElementById('search');
      const searchCount = document.getElementById('search-count');
      searchInput.addEventListener('input', () => {
        const q = searchInput.value.trim().toLowerCase();
        allNodes.forEach(n => n._hl = false);
        if (!q) { searchCount.textContent = ''; render(); return; }
        let cnt = 0;
        allNodes.forEach(n => {
          const nm = n.name.replace(/\n/g, ' ').toLowerCase(); if (nm.includes(q)) {
            n._hl = true; cnt++;
            // auto-expand parents
            (function expandTo(root, target) { if (root._id === target._id) return true; if (!root.children) return false; for (const c of root.children) { if (expandTo(c, target)) { root._collapsed = false; return true; } } return false; })(DATA, n);
          }
        });
        searchCount.textContent = cnt > 0 ? cnt + 'ä»¶' : '0ä»¶';
        render();
      });
      window.addEventListener('resize', () => { svg.setAttribute('width', window.innerWidth); svg.setAttribute('height', window.innerHeight); render(); });
      // Minimap
      const mmCanvas = document.getElementById('minimap'), mmCtx = mmCanvas.getContext('2d'), MM_W = 200, MM_H = 140;
      function renderMinimap() {
        const ctx = mmCtx; ctx.clearRect(0, 0, MM_W, MM_H);
        const vn = collect(DATA); if (vn.length === 0) return;
        let mnX = 1e9, mxX = -1e9, mnY = 1e9, mxY = -1e9;
        vn.forEach(n => { const x = n._x + _oX, y = n._y + _oY; mnX = Math.min(mnX, x); mxX = Math.max(mxX, x + nw(n)); mnY = Math.min(mnY, y - 15); mxY = Math.max(mxY, y + 15); });
        const pd = 10, rX = mxX - mnX || 1, rY = mxY - mnY || 1;
        const sc = Math.min((MM_W - pd * 2) / rX, (MM_H - pd * 2) / rY);
        const ox = pd + ((MM_W - pd * 2) - rX * sc) / 2, oy = pd + ((MM_H - pd * 2) - rY * sc) / 2;
        const tmx = x => ox + (x - mnX) * sc, tmy = y => oy + (y - mnY) * sc;
        vn.forEach(n => { const mx = tmx(n._x + _oX), my = tmy(n._y + _oY), sz = n._depth === 0 ? 4 : n._depth === 1 ? 2.5 : 1.5; ctx.fillStyle = n._hl ? '#fbbf24' : (n.color || '#94a3b8'); ctx.globalAlpha = n._depth <= 1 ? 0.9 : 0.5; ctx.beginPath(); ctx.arc(mx, my, sz, 0, Math.PI * 2); ctx.fill(); });
        ctx.globalAlpha = 1;
        const vl = -ct.x / ct.k, vt2 = -ct.y / ct.k, vw = W / ct.k, vh = H / ct.k;
        ctx.strokeStyle = 'rgba(255,255,255,0.6)'; ctx.lineWidth = 1.5; ctx.strokeRect(tmx(vl), tmy(vt2), vw * sc, vh * sc);
      }
      let mmDrag = false;
      function mmNav(e) {
        const rect = mmCanvas.getBoundingClientRect(), mx = (e.clientX || e.pageX) - rect.left, my = (e.clientY || e.pageY) - rect.top;
        const vn = collect(DATA); if (vn.length === 0) return;
        let mnX = 1e9, mxX = -1e9, mnY = 1e9, mxY = -1e9;
        vn.forEach(n => { const x = n._x + _oX, y = n._y + _oY; mnX = Math.min(mnX, x); mxX = Math.max(mxX, x + nw(n)); mnY = Math.min(mnY, y - 15); mxY = Math.max(mxY, y + 15); });
        const pd = 10, rX = mxX - mnX || 1, rY = mxY - mnY || 1;
        const sc = Math.min((MM_W - pd * 2) / rX, (MM_H - pd * 2) / rY);
        const ox = pd + ((MM_W - pd * 2) - rX * sc) / 2, oy = pd + ((MM_H - pd * 2) - rY * sc) / 2;
        ct.x = W / 2 - (mnX + (mx - ox) / sc) * ct.k; ct.y = H / 2 - (mnY + (my - oy) / sc) * ct.k;
        applyView();
      }
      mmCanvas.addEventListener('mousedown', e => { e.stopPropagation(); mmDrag = true; mmNav(e); });
      window.addEventListener('mousemove', e => { if (mmDrag) mmNav(e); });
      window.addEventListener('mouseup', () => { mmDrag = false; });
      mmCanvas.addEventListener('touchstart', e => { e.stopPropagation(); e.preventDefault(); mmDrag = true; mmNav(e.touches[0]); }, { passive: false });
      mmCanvas.addEventListener('touchmove', e => { e.preventDefault(); if (mmDrag) mmNav(e.touches[0]); }, { passive: false });
      mmCanvas.addEventListener('touchend', () => { mmDrag = false; });
      render();
    }).catch(e => { console.error('Failed to load data.json:', e); document.body.innerHTML = '<h1 style="color:red;text-align:center;margin-top:20vh">data.json ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</h1>'; });
  </script>
</body>

</html>